
# 1ï¸âƒ£ Login to Azure
echo "ğŸ”‘ Logging in to Azure..."
az login --use-device-code

# 2ï¸âƒ£ Set the subscription
echo "ğŸ“Œ Setting subscription..."
az account set --subscription "<SUBSCRIPTION_ID>"

# 3ï¸âƒ£ Install Bicep
echo "âš¡ Installing Bicep CLI..."
az bicep install --version v0.39.26
az bicep version

# 4ï¸âƒ£ Build template (optional)
echo "ğŸ›  Building Bicep template..."
az bicep build --file main.bicep --outfile main.arm.json

# 5ï¸âƒ£ Decompile ARM template (optional)
# Useful for debugging or converting back to Bicep
# az bicep decompile --file main.arm.json --force

# 6ï¸âƒ£ Dry-run (What-If)
echo "ğŸ” Running what-if analysis..."
az deployment sub what-if --location eastus2 --template-file main.bicep

# 7ï¸âƒ£ Validate template
echo "âœ… Validating Bicep template..."
az deployment sub validate --location eastus2 --template-file main.bicep

# 8ï¸âƒ£ Deploy infrastructure (always use --mode Complete for subscription scope)
echo "ğŸš€ Deploying Azure infrastructure..."
az deployment sub create \
  --location eastus2 \
  --template-file main.bicep \
  --parameters sshPublicKey="$(cat ~/.ssh/id_rsa.pub)" \
  --mode Complete

# 9ï¸âƒ£ Get outputs from deployment
echo "ğŸ“„ Retrieving deployment outputs..."
RG_NAME=$(az deployment sub show --name main --query properties.outputs.resourceGroupName.value -o tsv)
VM_IP=$(az deployment sub show --name main --query properties.outputs.vmPublicIp.value -o tsv)

echo "Resource Group: $RG_NAME"
echo "VM Public IP: $VM_IP"

# 1ï¸âƒ£0ï¸âƒ£ Create Role Assignment for Application (Contributor)
# This allows the app/service principal to deploy or manage resources in this RG
echo "ğŸ” Creating Role Assignment for App..."
az role assignment create \
  --assignee "<APP_CLIENT_ID>" \
  --role "Contributor" \
  --scope "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/$RG_NAME"

echo "âœ… Role assignment created."

# 1ï¸âƒ£1ï¸âƒ£ Cleanup example (optional)
# Uncomment if you want to remove all resources
# echo "ğŸ—‘ Deleting Resource Group..."
# az group delete --name "$RG_NAME" --yes --no-wait
```



### ğŸ”‘ Notes

# 1. **Replace placeholders**:

#    * `<SUBSCRIPTION_ID>` â†’ Your Azure subscription ID
#    * `<APP_CLIENT_ID>` â†’ Client ID of your application/service principal

# 2. **Outputs captured**:

#    * `RG_NAME` â†’ Resource Group name
#    * `VM_IP` â†’ VM public IP, useful for Ansible playbook or manual access

# 3. **Role Assignment**:

#    * Gives the application Contributor permissions on the newly created Resource Group
#    * Ensures your CI/CD app can deploy resources if needed

# 4. **Optional cleanup**:

#    * Uncomment last section to remove all resources after testing



